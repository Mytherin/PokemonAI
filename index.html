
<canvas id="pokemoncanvas" width="800" height="600" style="margin-left:auto;margin-right:auto;">

</canvas>

<script>
var canvas = document.getElementById("pokemoncanvas");
var c = canvas.getContext("2d");

SCALE = 8/3;

var HEALTHBAR_HEIGHT = 6*SCALE;
var HEALTHBAR_WIDTH = 80*SCALE;
var HEALTHBAR_FONTSIZE = 10*SCALE;

var INTERFACE_FONTSIZE = 15*SCALE

battle_width = 800;
battle_height = 450;
interface_height = 150

var backgroundImage = new Image();
backgroundImage.src = 'images/background.png';

var pokemons = [{"id":1,"name":"Bulbasaur","speed":45,"special_defense":65,"special_attack":65,"defense":49,"attack":49,"hp":45,"types":["poison","grass"],"img_front":"images/bulbasaur-front.gif","img_back":"images/bulbasaur-back.gif"},{"id":4,"name":"Charmander","speed":65,"special_defense":50,"special_attack":60,"defense":43,"attack":52,"hp":39,"types":["fire"],"img_front":"images/charmander-front.gif","img_back":"images/charmander-back.gif"},{"id":7,"name":"Squirtle","speed":43,"special_defense":64,"special_attack":50,"defense":65,"attack":48,"hp":44,"types":["water"],"img_front":"images/squirtle-front.gif","img_back":"images/squirtle-back.gif"},{"id":25,"name":"Pikachu","speed":90,"special_defense":50,"special_attack":50,"defense":40,"attack":55,"hp":35,"types":["electric"],"img_front":"images/pikachu-front.gif","img_back":"images/pikachu-back.gif", "attacks": ["thunderbolt", "quick attack", "thunder wave", "thunder shock"]},{"id":39,"name":"Jigglypuff","speed":20,"special_defense":25,"special_attack":45,"defense":20,"attack":45,"hp":115,"types":["fairy","normal"],"img_front":"images/jigglypuff-front.gif","img_back":"images/jigglypuff-back.gif"},{"id":52,"name":"Meowth","speed":90,"special_defense":40,"special_attack":40,"defense":35,"attack":45,"hp":40,"types":["normal"],"img_front":"images/meowth-front.gif","img_back":"images/meowth-back.gif"},{"id":56,"name":"Mankey","speed":70,"special_defense":45,"special_attack":35,"defense":35,"attack":80,"hp":40,"types":["fighting"],"img_front":"images/mankey-front.gif","img_back":"images/mankey-back.gif"},{"id":16,"name":"Pidgey","speed":56,"special_defense":35,"special_attack":35,"defense":40,"attack":45,"hp":40,"types":["flying","normal"],"img_front":"images/pidgey-front.gif","img_back":"images/pidgey-back.gif", "attacks": ["tackle", "air slash", "gust", "steel wing"]},{"id":23,"name":"Ekans","speed":55,"special_defense":54,"special_attack":40,"defense":44,"attack":60,"hp":35,"types":["poison"],"img_front":"images/ekans-front.gif","img_back":"images/ekans-back.gif"},{"id":74,"name":"Geodude","speed":20,"special_defense":30,"special_attack":30,"defense":100,"attack":80,"hp":40,"types":["ground","rock"],"img_front":"images/geodude-front.gif","img_back":"images/geodude-back.gif"},{"id":27,"name":"Sandshrew","speed":40,"special_defense":30,"special_attack":20,"defense":85,"attack":75,"hp":50,"types":["ground"],"img_front":"images/sandshrew-front.gif","img_back":"images/sandshrew-back.gif"},{"id":96,"name":"Drowzee","speed":42,"special_defense":90,"special_attack":43,"defense":45,"attack":48,"hp":60,"types":["psychic"],"img_front":"images/drowzee-front.gif","img_back":"images/drowzee-back.gif"},{"id":92,"name":"Gastly","speed":80,"special_defense":35,"special_attack":100,"defense":30,"attack":35,"hp":30,"types":["poison","ghost"],"img_front":"images/gastly-front.gif","img_back":"images/gastly-back.gif"},{"id":12,"name":"Butterfree","speed":70,"special_defense":80,"special_attack":90,"defense":50,"attack":45,"hp":60,"types":["flying","bug"],"img_front":"images/butterfree-front.gif","img_back":"images/butterfree-back.gif"},{"id":147,"name":"Dratini","speed":50,"special_defense":50,"special_attack":50,"defense":45,"attack":64,"hp":41,"types":["dragon"],"img_front":"images/dratini-front.gif","img_back":"images/dratini-back.gif"}]

var attacks = [{"name": "tackle", "power": 40, "type": "normal", "status": "none"}, {"name": "air slash", "power": 75, "type": "flying", "status": "none"}, {"name": "gust", "power": 40, "type": "flying", "status": "none"}, {"name": "steel wing", "power": 70, "type": "steel", "status": "none"}, {"name": "thunderbolt", "power": 90, "type": "electric", "status": "none"}, {"name": "quick attack", "power": 40, "type": "normal", "status": "none", "priority": 1}, {"name": "thunder wave", "power": 0, "type": "electric", "status": "paralysis"}, {"name": "thunder shock", "power": 40, "type": "electric", "status": "none"}]

function getAttackInfo(attackName) {
	for (var i = 0; i < attacks.length; i++) {
		if (attacks[i].name.toLowerCase() == attackName.toLowerCase()) {
			return attacks[i]
		}
	}
	return {}
}

var type_colors = {}
type_colors["water"] = "63B8FF"
type_colors["electric"] = "#CDCD00"
type_colors["fire"] = "#B22222"
type_colors["grass"] = "#228B22"
type_colors["ghost"] = "#5D478B"
type_colors["psychic"] = "#CD6090"
type_colors["normal"] = "#6C7B8B"
type_colors["fighting"] = "#8B4513"
type_colors["flying"] = "#a890f0"
type_colors["poison"] = "#a040a0"
type_colors["ghost"] = "#705898"
type_colors["dark"] = "#705848"
type_colors["dragon"] = "#7038f8"
type_colors["bug"] = "#a8b820"
type_colors["psychic"] = "#f85888"
type_colors["ice"] = "#98d8d8"
type_colors["steel"] = "#b8b8d0"

types = ["Normal", "Fighting", "Flying", "Poison", "Ground", "Rock", "Bug", "Ghost", "Steel", "Fire", "Water", "Grass", "Electric", "Psychic", "Ice", "Dragon", "Dark", "Fairy"]
weaknesses = [[1, 1, 1, 1, 1, 0.5, 1, 0, 0.5, 1, 1, 1, 1, 1, 1, 1, 1, 1], [2, 1, 0.5, 0.5, 1, 2, 0.5, 0, 2, 1, 1, 1, 1, 0.5, 2, 1, 2, 0.5], [1, 2, 1, 1, 1, 0.5, 2, 1, 0.5, 1, 1, 2, 0.5, 1, 1, 1, 1, 1], [1, 1, 1, 0.5, 0.5, 0.5, 1, 0.5, 0, 1, 1, 2, 1, 1, 1, 1, 1, 2], [1, 1, 0, 2, 1, 2, 0.5, 1, 2, 2, 1, 0.5, 2, 1, 1, 1, 1, 1], [1, 0.5, 2, 1, 0.5, 1, 2, 1, 0.5, 2, 1, 1, 1, 1, 2, 1, 1, 1], [1, 0.5, 0.5, 0.5, 1, 1, 1, 0.5, 0.5, 0.5, 1, 2, 1, 2, 1, 1, 2, 0.5], [0, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 2, 1, 1, 0.5, 1], [1, 1, 1, 1, 1, 2, 1, 1, 0.5, 0.5, 0.5, 1, 0.5, 1, 2, 1, 1, 2], [1, 1, 1, 1, 1, 0.5, 2, 1, 2, 0.5, 0.5, 2, 1, 1, 2, 0.5, 1, 1], [1, 1, 1, 1, 2, 2, 1, 1, 1, 2, 0.5, 0.5, 1, 1, 1, 0.5, 1, 1], [1, 1, 0.5, 0.5, 2, 2, 0.5, 1, 0.5, 0.5, 2, 0.5, 1, 1, 1, 0.5, 1, 1], [1, 1, 2, 1, 0, 1, 1, 1, 1, 1, 2, 0.5, 0.5, 1, 1, 0.5, 1, 1], [1, 2, 1, 2, 1, 1, 1, 1, 0.5, 1, 1, 1, 1, 0.5, 1, 1, 0, 1], [1, 1, 2, 1, 2, 1, 1, 1, 0.5, 0.5, 0.5, 2, 1, 1, 0.5, 2, 1, 1], [1, 1, 1, 1, 1, 1, 1, 1, 0.5, 1, 1, 1, 1, 1, 1, 2, 1, 0], [1, 0.5, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 2, 1, 1, 0.5, 0.5], [1, 2, 1, 0.5, 1, 1, 1, 1, 0.5, 0.5, 1, 1, 1, 1, 1, 2, 2, 1]]

var pokemon_images = {}

var active_pokemon_p1 = {};
var active_pokemon_p2 = {};

active_pokemon_p1.index = 3;
active_pokemon_p1.health = 1;
active_pokemon_p1.display_health = 1;
active_pokemon_p1.frame = 0;

active_pokemon_p2.index = 7;
active_pokemon_p2.health = 1;
active_pokemon_p2.display_health = 1;
active_pokemon_p2.frame = 0;

var HEALTH_ANIMATION_SPEED = 0.01;

String.prototype.toProperCase = function () {
    return this.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
};

for (var i = 0; i < pokemons.length; i++) {
	var pkmn = pokemons[i].name.toLowerCase();
	pokemon_images[pkmn] = {};
	var image = new Image();
	image.src = 'images/' + pkmn + '-front.png'
	pokemon_images[pkmn].front = image;
	var image = new Image();
	image.src = 'images/' + pkmn + '-back.png'
	pokemon_images[pkmn].back = image;
}

function drawBackground(c, backgroundImage, x, y, width, height) {
	c.drawImage(backgroundImage, x, y, width, height);
}

function drawType(type, x, y, width, fontsize) {
	old_style = c.fillStyle;
	old_font = c.font;

	c.font = "bold " + fontsize + "px Calibri";
	c.fillStyle = type_colors[type];
	c.fillRect(x, y, width, 10*SCALE);

	c.strokeStyle = "#000000"
	c.strokeRect(x, y, width, 10*SCALE);

	var size = c.measureText(type.toProperCase());
	c.fillStyle = "#FFFFFF"
	c.fillText(type.toProperCase(), x + (width - size.width) / 2, y + 4*SCALE + (fontsize - 2*SCALE) / 2)
	c.fillStyle = old_style
	c.font = old_font;
}

function drawHealthBar(c, x, y, percentage, name, types) {
	c.font = "bold " + HEALTHBAR_FONTSIZE + "px Calibri";

	var size = c.measureText("HP");
	c.fillStyle = "#222222"
	c.fillText("HP", x - size.width - 5*SCALE, y + HEALTHBAR_FONTSIZE / 4);

	// first draw the background of the health bar
	var grd = c.createLinearGradient(x, y - HEALTHBAR_HEIGHT / 2, x, y + HEALTHBAR_HEIGHT / 2);
	grd.addColorStop(0.0, "#B2B2B2");
	grd.addColorStop(0.5, "#FFFFFF");
	grd.addColorStop(1.0, "#B2B2B2");

	c.fillStyle = grd;
	c.fillRect(x, y - HEALTHBAR_HEIGHT / 2, HEALTHBAR_WIDTH, HEALTHBAR_HEIGHT);

	// now draw the foreground
	var grd = c.createLinearGradient(x, y - HEALTHBAR_HEIGHT / 2, x, y + HEALTHBAR_HEIGHT / 2);
	if (percentage > 0.5) {
		c1 = "#1C472B";
		c2 = "#2BC741";
	} else if (percentage > 0.25) {
		c1 = "#8F3F00";
		c2 = "#FF7F00";
	} else {
		c1 = "#811111";
		c2 = "#B22222";
	}
	grd.addColorStop(0.0, c1);
	grd.addColorStop(0.5, c2);
	grd.addColorStop(1.0, c1);

	c.fillStyle = grd;
	c.fillRect(x, y - HEALTHBAR_HEIGHT / 2, HEALTHBAR_WIDTH * percentage, HEALTHBAR_HEIGHT);
	c.strokeStyle = "#000000";
	c.strokeRect(x, y - HEALTHBAR_HEIGHT / 2, HEALTHBAR_WIDTH, HEALTHBAR_HEIGHT);

	var size = c.measureText(name)
	c.fillStyle = "#000000"
	c.fillText(name, x + (HEALTHBAR_WIDTH - size.width) / 2, y - HEALTHBAR_FONTSIZE / 2);

	c.font = "bold " + (HEALTHBAR_FONTSIZE - 2) + "px Calibri";

	for (var i = 0; i < types.length; i++) {
		var type = types[i];
		c.fillStyle = type_colors[type];
		c.fillRect(x + i * (HEALTHBAR_WIDTH / 2), y + HEALTHBAR_HEIGHT, HEALTHBAR_WIDTH / 2, 10*SCALE);

		c.strokeStyle = "#000000"
		c.strokeRect(x + i * (HEALTHBAR_WIDTH / 2), y + HEALTHBAR_HEIGHT, HEALTHBAR_WIDTH / 2, 10*SCALE);

		var size = c.measureText(type.toProperCase());
		c.fillStyle = "#FFFFFF"
		c.fillText(type.toProperCase(), x + (HEALTHBAR_WIDTH / 2 - size.width) / 2 + i * (HEALTHBAR_WIDTH / 2), y + HEALTHBAR_HEIGHT + 4*SCALE + (HEALTHBAR_FONTSIZE - 2*SCALE) / 2)
	}

}

function drawPokemon(c, pkmn, isFront) {
	var image;
	var name = pokemons[pkmn.index].name.toProperCase();
	var health = pkmn.display_health;
	var types = pokemons[pkmn.index].types
	if (isFront) {
		image = pokemon_images[name.toLowerCase()].front;
	} else {
		image = pokemon_images[name.toLowerCase()].back;
	}
	if (isFront) {
		x = battle_width - 80*SCALE - (image.height*SCALE) / 2;
		y = 90*SCALE - image.height*SCALE;
	} else {
		x = 50*SCALE;
		y = battle_height - 30*SCALE - image.height*SCALE;
	}
	current_frame = Math.round(pkmn.frame);
	total_frames = Math.round(image.width / image.height);
	c.drawImage(image,
		current_frame * image.height,
		0,
		image.height,
		image.height,
		x,
		y,
		image.height*SCALE,
		image.height*SCALE);
	// move to the next frame
	if (pkmn.frame + 1 >= total_frames) {
		pkmn.frame = 0;
	} else {
		pkmn.frame += 0.3;
	}

	if (isFront) {
		drawHealthBar(c, 50*SCALE, 30*SCALE, health, name, types);
	} else {
		drawHealthBar(c, battle_width - 40*SCALE - HEALTHBAR_WIDTH, battle_height - 40*SCALE, health, name, types);
	}
}

INTERFACE_SELECT_MOVE = 1
INTERFACE_DISPLAY_TEXT = 2
INTERFACE_SELECT_POKEMON = 3

active_move = 0
flicker = 0;
interface_state = INTERFACE_SELECT_MOVE

function updateInterface() {

}

function drawInterface() {
	c.fillStyle = "#EEEEEE";
	c.fillRect(0, battle_height, battle_width, interface_height);
	c.strokeStyle = "#000000";
	c.strokeRect(0, battle_height, battle_width, interface_height);

	if (interface_state == INTERFACE_SELECT_MOVE) {
		c.font = "bold " + INTERFACE_FONTSIZE + "px Calibri";
		c.fillStyle = "#000000";

		var TYPE_OFFSET = 275
		var TYPE_WIDTH = 100

		var attacks = pokemons[active_pokemon_p2.index].attacks
		c.fillText(attacks[0].toProperCase(), 60, battle_height + 20 + INTERFACE_FONTSIZE);
		drawType(getAttackInfo(attacks[0]).type, TYPE_OFFSET, battle_height + 35, TYPE_WIDTH, HEALTHBAR_FONTSIZE, HEALTHBAR_FONTSIZE);
		c.strokeRect(10, battle_height + 20, TYPE_OFFSET + TYPE_WIDTH, 50)
		
		c.fillText(attacks[1].toProperCase(), 60, battle_height + 80 + INTERFACE_FONTSIZE);
		drawType(getAttackInfo(attacks[1]).type, TYPE_OFFSET, battle_height + 95, TYPE_WIDTH, HEALTHBAR_FONTSIZE, HEALTHBAR_FONTSIZE);
		c.strokeRect(10, battle_height + 80, TYPE_OFFSET + TYPE_WIDTH, 50)

		c.fillText(attacks[2].toProperCase(), battle_width - 60 - c.measureText(attacks[2].toProperCase()).width, battle_height + 20 + INTERFACE_FONTSIZE);
		drawType(getAttackInfo(attacks[2]).type, battle_width - TYPE_OFFSET - TYPE_WIDTH, battle_height + 35, TYPE_WIDTH, HEALTHBAR_FONTSIZE, HEALTHBAR_FONTSIZE);
		c.strokeRect(battle_width - TYPE_WIDTH - TYPE_OFFSET - 10, battle_height + 20, TYPE_OFFSET + TYPE_WIDTH, 50)

		c.fillText(attacks[3].toProperCase(), battle_width - 60 - c.measureText(attacks[3].toProperCase()).width, battle_height + 80 + INTERFACE_FONTSIZE);
		drawType(getAttackInfo(attacks[3]).type, battle_width - TYPE_OFFSET - TYPE_WIDTH, battle_height + 95, TYPE_WIDTH, HEALTHBAR_FONTSIZE, HEALTHBAR_FONTSIZE);
		c.strokeRect(battle_width - TYPE_WIDTH - TYPE_OFFSET - 10, battle_height + 80, TYPE_OFFSET + TYPE_WIDTH, 50)

		base_y = battle_height + 25;

		if (active_move == 0) {
			x1 = 20;
			x2 = 40;
			x3 = 20;
			y1 = base_y + INTERFACE_FONTSIZE / 5;
			y2 = y1 + INTERFACE_FONTSIZE / 3;
			y3 = y2 + INTERFACE_FONTSIZE / 3;
		} else if (active_move == 1) {
			base_y = battle_height + 85;
			x1 = 20;
			x2 = 40;
			x3 = 20;
			y1 = base_y + INTERFACE_FONTSIZE / 5;
			y2 = y1 + INTERFACE_FONTSIZE / 3;
			y3 = y2 + INTERFACE_FONTSIZE / 3;
		} else if (active_move == 2) {
			x1 = battle_width - 20;
			x2 = battle_width - 40;
			x3 = battle_width - 20;
			y1 = base_y + INTERFACE_FONTSIZE / 5;
			y2 = y1 + INTERFACE_FONTSIZE / 3;
			y3 = y2 + INTERFACE_FONTSIZE / 3;
		} else if (active_move == 3) {
			base_y = battle_height + 85;
			x1 = battle_width - 20;
			x2 = battle_width - 40;
			x3 = battle_width - 20;
			y1 = base_y + INTERFACE_FONTSIZE / 5;
			y2 = y1 + INTERFACE_FONTSIZE / 3;
			y3 = y2 + INTERFACE_FONTSIZE / 3;
		}
		c.beginPath();
	    c.moveTo(x1, y1);
	    c.lineTo(x2, y2);
	    c.lineTo(x3, y3);
	    c.fill();
	}
}

function update_health(pkmn) {
	if (Math.abs(pkmn.display_health - pkmn.health) <= HEALTH_ANIMATION_SPEED) {
		pkmn.display_health = pkmn.health;
	} else if (pkmn.display_health < pkmn.health) {
		pkmn.display_health += HEALTH_ANIMATION_SPEED;
	} else if (pkmn.display_health > pkmn.health) {
		pkmn.display_health -= HEALTH_ANIMATION_SPEED;
	}
}

function update() {
	updateInterface();
	update_health(active_pokemon_p1);
	update_health(active_pokemon_p2);
}

function render() {
	drawBackground(c, backgroundImage, 0, 0, battle_width, battle_height);
	drawPokemon(c, active_pokemon_p2, false)
	drawPokemon(c, active_pokemon_p1, true)
	drawInterface();
}

function loop(timestamp) {
	var t = timestamp - lastRender

	update();
	render();

	lastRender = timestamp
	window.requestAnimationFrame(loop)
}

document.onkeydown = function(evt) {
    evt = evt || window.event;

    if (interface_state == INTERFACE_SELECT_MOVE) {
    	console.log(evt.keyCode)
		if (evt.keyCode == 40 || evt.keyCode == 38) {
			// down arrow or up arrow
			if (active_move == 0) {
				active_move = 1;
			} else if (active_move == 1) {
				active_move = 0;
			} else if (active_move == 2) {
				active_move = 3;
			} else if (active_move == 3) {
				active_move = 2;
			}
		} else if (evt.keyCode == 37 || evt.keyCode == 39) {
			// left arrow or right arrow
			if (active_move == 0) {
				active_move = 2;
			} else if (active_move == 1) {
				active_move = 3;
			} else if (active_move == 2) {
				active_move = 0;
			} else if (active_move == 3) {
				active_move = 1;
			}
		}
    }
};

var lastRender = 0
window.requestAnimationFrame(loop);

</script>